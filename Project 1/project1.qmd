---
title: "Project 1: Exploratory Data Analysis"
author: "Tianna Chan"
format: pdf
include-in-header: 
  text: |
    \usepackage{fvextra}
    \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
editor: visual
execute:
  echo: false
  warning: false
  error: false
  eval: true
  output: true
---

# Project 1: Exploratory Data Analysis

```{r}
#| label: setup
#| include: false


library(readr)
library(tidyverse)
set.seed(123456)
library(knitr)
library(tidyr)   
library(dplyr)    
library(kableExtra)
library(readr)
library(visdat)
library(naniar)
library(gtsummary)
library(patchwork)
library(DataExplorer)
library(lubridate) #To convert time
```

```{r}
# Import data sets
aqi_values <- read_csv("aqi_values.csv")
course_record <- read_csv("course_record.csv")
marathon_dates <- read_csv("marathon_dates.csv")
project1 <- read_csv("project1.csv")

colnames(project1) <- c("Race", "Year", "Sex", "Flag", "Age", "%CR", "Td", "Tw", "%rh", "Tg", "SR", "DP", "Wind", "WBGT")
```

## Missing Data

To understand the data set, I first generated a missing data plot by `vis_miss()`. The plot shows that there was a consistent 4% of missing data for the flag and weather measurement columns. This indicates that weather was not measured at these races. After some further exploration, table below shows that all data were missing at races 1 (Chicago), 2 (NYC), 3 (Twin Cities) at 2011, and race 4 (Grandmaâ€™s) at 2012.

The flag for these were missing because they should have been calculated by the wet bulb globe temperature (WBGT), and the WBGT is also calculated by the other temperature variables, which were not measured and is dependent on these particular races in particular year. Therefore, the probability of the flag and WBGT being missing depends on both observed and unobserved variables, this should then be a case of **Missing Not at Random (MNAR).** For the other weather variables, they were missing because they are not measured in that particular year/race, but we do not have knowledge on the exact reason. Therefore, the probability of them being missing depends only on observed variables (year/race), they would then be a case of **Missing at Random (MAR).**

```{r}
## Missing data plot
# project1 %>% abbreviate_vars() %>% vis_miss()

## Missing data table
project1 %>% group_by(Race, Year) %>%
  summarize(n_miss = sum(is.na(Flag)),
            n_tot = n()) %>%
  filter(n_miss > 0) %>%
  kable(booktabs = TRUE, digits = 2)
  
```

## Data Quality

Using `str()`, the variable type for each columns in the data set is shown. The race column was numeric, with values 0, 1, 2, 3, 4. Recoding them into B, C, NY, TC, D would help ease the process of understanding the data and merging with the course record data later. It is further factorized. Similar process for sex, recoding to "M" and "F". Additonally, the Sex and Flag were originally numeric and character variables, and they are also factorized to make sure future analysis treat them the way we want. For the others, they are in the correct numeric value type.

```{r}
## Data Quality
# str(project1)

project1 <- project1 %>% 
  mutate(Race = case_when(
    Race == 0 ~ "B",
    Race == 1 ~ "C",
    Race == 2 ~ "NY",
    Race == 3 ~ "TC",
    Race == 4 ~ "D",
    ),
    Sex = case_when(
    Sex == 0 ~ "F",
    Sex == 1 ~ "M"
    )
    ) %>%
  mutate(across(c(Race, Sex, Flag), 
         as.factor))
```

```{r}
plot_histogram(project1, nrow = 5L)
# plot_bar(project1, ncol = 5L)
```

## Participant And Race Characteristics

```{r}
project1 %>% dplyr::select(Race, Age, Sex, Flag)%>%
  tbl_summary(by = Sex, 
              type = list(where(is.numeric) ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean} ({p25}, {p75})")) %>% 
  bold_labels()
  #add_p()
```

## Merging Data

The course record data is merged so we can use the record to calculate time by each participant.

```{r}
course_record <- course_record %>% rename("Sex" = "Gender")

project1_CR <- project1 %>% 
  left_join(course_record, by = c("Race", "Year", "Sex"))

project1_CR$Time <- (project1_CR$CR * (1+project1_CR$`%CR`/100)) %>% 
  as.numeric() %>% seconds_to_period()
```

-   AIM 1: Examine effects of increasing age on marathon performance in men and women

```{r}
ggplot(project1_CR, aes(x = Age, y = Time)) +
  geom_point(aes(color=Sex)) +  # Scatter plot
  #facet_wrap(~ Sex) +  # Facet by Sex
  labs(title = "Time vs Age Faceted by Sex",
       x = "Age",
       y = "Time (Seconds)") +
  theme_minimal()
```

-   AIM 2: Explore the impact of environmental conditions on marathon performance, and whether the impact differs across age and gender.

-   AIM3: Identify the weather parameters (WBGT, Flag conditions, temperature, etc) that have the largest impact on marathon performance.
